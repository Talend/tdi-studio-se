<%@ jet 
imports="
    	org.talend.core.model.process.INode    
    	org.talend.core.model.process.ElementParameterParser
		org.talend.designer.codegen.config.CodeGeneratorArgument
		" 
%>
<%@ include file="@{org.talend.designer.components.localprovider}/components/templates/Log4j/LogUtil.javajet"%>
<%
	CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
	INode node = (INode)codeGenArgument.getArgument();
	LogUtil logUtil = new LogUtil(node);
	String cid = node.getUniqueName();
	String destination = ElementParameterParser.getValue(node, "__DESTINATION__");
	if(destination!=null && !"".equals(destination)){
		cid = destination;
	}
	boolean useExistingConn = ("true").equals(ElementParameterParser.getValue(node,"__USE_EXISTING_CONNECTION__"));
	
	boolean isMassInsert =("true").equals(ElementParameterParser.getValue(node,"__EXTENDINSERT__"));
	boolean withReport = ("true").equals(ElementParameterParser.getValue(node,"__WITHREPORT__"));
	
	boolean isStaging = "STAGING".equalsIgnoreCase(ElementParameterParser.getValue(node, "__CONTAINER_TYPE__"));
	
	boolean addTaskID = ("true").equals(ElementParameterParser.getValue(node,"__ADD_TASKID__"));
	String taskID = ElementParameterParser.getValue(node,"__TASKID__");
	boolean usePartialUpdate = ("true").equals(ElementParameterParser.getValue(node,"__USE_PARTIAL_UPDATE__"));
%>

<%
if(!usePartialUpdate){%>
    <% logUtil.info("\"Try to use full update.\"");%>
<%
	if(isMassInsert){
		if(!isStaging && withReport){
%> 
    <% logUtil.info("\"Try to put item with report to master data.\"");%>
    
	if(miList_<%=cid %>.size() > 0){
	    org.talend.mdm.webservice.WSPutItemWithReportArray putItemWithReportArray = new org.talend.mdm.webservice.WSPutItemWithReportArray(miList_<%=cid %>);
	    
	    <% logUtil.info("\"Try to put item with report array.\"");%>
	    
		wspks_<%=cid %> = service_<%=cid %>.putItemWithReportArray(putItemWithReportArray).getWsItemPK();
		
	    <% logUtil.debug("\"Put item size:\"+wspks_"+cid+".size()");%>
	    <% logUtil.info("\"Put item with report array successfully.\"");%>
	    
		miList_<%=cid %>.clear();
		miList_<%=cid %> = null;
		<%if(addTaskID){%>
		    <% logUtil.info("\"Try to add task id.\"");%>
			int i2_<%=cid %> = 0;
		    for(org.talend.mdm.webservice.WSItemPK wspk2_<%=cid %> : wspks_<%=cid %>){
		        String compositeId = "";
		        for(String id:wspk2_<%=cid %>.getIds()) {
		          compositeId += id;
		        }
		        <% logUtil.debug("\"Add task id for item :\"+compositeId");%>
		        
		    	wspk2_<%=cid %>.setWsDataClusterPK(dataCluster_<%=cid %>);
		    	service_<%=cid %>.updateItemMetadata(util_<%=cid%>.makeUpdateMeteItm(taskIDs_<%=cid%>.get(i2_<%=cid %>), wspk2_<%=cid %>));
		    	i2_<%=cid %>++;
		    }
		    <% logUtil.info("\"Add task ids successfully.\"");%>
        	taskIDs_<%=cid%>.clear();
        <%}%>
	}
<%
		}else{%>
	if(miList_<%=cid %>.size() > 0){
	    <% logUtil.info("\"Try to put item array.\"");%>
	    
		wspks_<%=cid %> = service_<%=cid %>.putItemArray(miList_<%=cid %>).getWsItemPK();
		
		<% logUtil.debug("\"Put item size:\"+wspks_"+cid+".size()");%>
		
		miList_<%=cid %>.clear();
		miList_<%=cid %> = null;
		<%if(addTaskID){%>
		    <% logUtil.info("\"Try to add task id.\"");%>
		    
        	int i2_<%=cid %> = 0;
		    for(org.talend.mdm.webservice.WSItemPK wspk2_<%=cid %> : wspks_<%=cid %>){
		        
		        String compositeId = "";
                for(String id:wspk2_<%=cid %>.getIds()) {
                  compositeId += id;
                }
                <% logUtil.debug("\"Add task id for item :\"+compositeId");%>
                
		    	wspk2_<%=cid %>.setWsDataClusterPK(dataCluster_<%=cid %>);
		    	service_<%=cid %>.updateItemMetadata(util_<%=cid%>.makeUpdateMeteItm(taskIDs_<%=cid%>.get(i2_<%=cid %>), wspk2_<%=cid %>));
		    	i2_<%=cid %>++;
		    }
		    <% logUtil.info("\"Add task ids successfully.\"");%>
        	taskIDs_<%=cid%>.clear();
        <%}%>
	}
<%
		}
	}
}%>
 	<%if(!useExistingConn){%>
 	    <% logUtil.info("\"To close service.\"");%>
 		service_<%=cid %>.logout(new org.talend.mdm.webservice.WSLogout());
 		<% logUtil.info("\"Close service successfully.\"");%>
 	<%}%>
 	
 	<% logUtil.info("\"Write record count: \"+nb_line_"+cid+"+\".\"");%>
 	globalMap.put("<%=cid %>_NB_LINE",nb_line_<%=cid %>);             
 	globalMap.put("<%=cid %>_NB_LINE_REJECTED",nb_line_rejected_<%=cid%>);
            